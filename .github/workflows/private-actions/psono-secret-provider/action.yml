# action.yml
name: 'PSONO Secret Whisperer'
description: 'Fetches secrets from PSONO server and makes them available as outputs'
author: 'J.F.Heinrich'
branding:
  icon: 'lock'
  color: 'blue'

inputs:
  ci_api_key_id:  # id of input
    description: 'PSONO API key'
    required: true
  ci_api_secret_key_hex:
    description: 'PSONO API secret key'
    required: true
  secret_id:
    description: 'Secret ID to fetch'
    required: true
  ci_server_url:
    description: 'The URL of the PSONO server, default: https://www.psono.pw/server'
    default: 'https://www.psono.pw/server'
  secret_type:
    description: 'Type of secret tp fetch: env or secret, default: secret'
    default: 'secret'
  secret_fields:
    description: 'Comma-separated list of secret keys to retrieve, default: username,password'
    default: 'username,password'
  mask_secrets:
    description: 'Comma-separated list of secret keys to be masked'

outputs:
  secrets:
    description: 'Each secret is available as an individual output'

runs:
  using: 'composite'
  steps:
    - name: Fetch secrets from PSONO
      shell: bash
      run: |
        if [ -n "$(which curl)" ]; then
          curl https://get.psono.com/psono/psono-ci/x86_64-linux/psonoci --output $psonoci >/dev/null
          chmod +x $psonoci
        elif [ -n "$(which wget)" ]; then
          wget --output-document $psonoci https://get.psono.com/psono/psono-ci/x86_64-linux/psonoci >/dev/null
          chmod +x $psonoci
        else
          echo "Neither curl nor WGET found. Cancled"
          exit 1
        fi
        if [ -x $psono ]; then
          ${{ github.action_path }}/fetch_secrets.sh
        else
          ls -la ${{ github.action_path }}
        fi
      env:
        psonoci: ${{ github.action_path }}/psonoci
        PSONO_CI_API_KEY_ID: ${{ inputs.ci_api_key_id }}
        PSONO_CI_API_SECRET_KEY_HEX: ${{ inputs.ci_api_secret_key_hex }}
        PSONO_CI_SERVER_URL: ${{ inputs.ci_server_url }}
        SECRET_TYPE: ${{ inputs.secret_type }}
        SECRET_ID: ${{ inputs.secret_id }}
        SECRET_FIELDS: ${{ inputs.secret_fields }}
        MASK_SECRETS: ${{ inputs.mask_secrets }}
